# 公安专网单向 FTP 文件交换实施方案

## 1. 背景与约束

- 部署环境：公安专网 / 政务内网
    
- 网络特性：
    
    - 专网与外网物理或逻辑隔离
        
    - **FTP 仅支持外网 → 专网单向写入（只能进不能出）**
        
    - 专网禁止主动访问外网（HTTP / DB / MQ 等）
        

## 2. 设计目标

- 安全合规：满足公安专网、等保、测评要求
    
- 稳定可靠：支持重复投递、异常恢复
    
- 可审计：文件可追溯、过程可回溯
    
- 易扩展：支持多业务、多操作类型
    

## 3. 总体架构

```
外网业务系统  ──FTP(单向)──►  专网FTP服务器  ──►  专网业务处理服务
```

- 外网：仅负责生成并投递业务文件
    
- 专网：被动接收文件并本地处理
    
- 不存在任何回执、回调、回写
    

## 4. 业务区分设计

### 4.1 三层区分机制

1. **FTP 目录区分业务**
    
2. **文件命名规范辅助识别**
    
3. **文件协议字段最终判定**
    

### 4.2 FTP 目录规划

```
/ftp_root/incoming/
  ├── event/     # 事件类业务
  ├── clue/      # 线索类业务
  ├── report/    # 报告类业务
```

> FTP 用户仅允许写入 `incoming` 下对应业务目录

### 4.3 文件命名规范

```
系统编码_业务编码_时间戳_序号.json
```

示例：

```
EAGLE_EVT_20260106153000_001.json
```

## 5. 新增 / 修改 / 删除区分方案

### 5.1 操作类型设计

在文件协议中明确操作类型字段：`opType`

```text
ADD     新增
UPDATE  修改
DELETE  删除
```

### 5.2 文件协议结构（统一格式）

```json
{
  "fileId": "20260106153000123",
  "bizType": "EVENT",
  "opType": "ADD",
  "version": "1.0",
  "createTime": "2026-01-06 15:30:00",
  "data": {
    "eventId": "EVT123",
    "title": "xxx",
    "content": "xxx"
  }
}
```

- `bizType`：业务实体类型
    
- `opType`：操作语义
    
- `fileId`：文件级全局唯一标识（幂等关键）
    

## 6. 文件传输与完整性保障

### 6.1 防止半文件读取

采用 **临时文件 + 重命名** 方式：

```
xxx.json.tmp  →  xxx.json
```

- 仅处理无 `.tmp` 后缀文件
    
- FTP rename 为原子操作
    

### 6.2 文件稳定性校验

- 文件大小连续 N 秒不变化后才处理
    

## 7. 专网文件处理流程设计

### 7.1 目录结构

```
/ftp_root/
  ├── incoming/      # 待处理
  ├── processing/    # 处理中
  ├── success/       # 处理成功
  └── error/         # 处理失败
```

### 7.2 标准处理流程

```
1. 定时扫描 incoming
2. 校验文件稳定性
3. 原子 move → processing
4. 记录处理日志（处理中）
5. 解析文件协议
6. 根据 bizType + opType 执行业务逻辑
7. 成功 → success
8. 失败 → error
9. 更新处理日志状态
```

## 8. 防重复执行设计（三重保障）

### 8.1 目录迁移（物理隔离）

- 只扫描 `incoming`
    
- 已处理文件不再存在于扫描目录
    

### 8.2 文件处理台账（逻辑隔离）

```sql
t_file_process_log
----------------------------
file_id      PK
file_name
biz_type
op_type
status        -- 0处理中 1成功 2失败
process_time
error_msg
```

- 同一 `fileId` 只允许成功一次
    

### 8.3 业务幂等（兜底保障）

- 基于业务主键设置唯一约束
    
- DELETE 操作采用逻辑删除
    

## 9. 删除操作处理原则

- 禁止物理删除
    
- DELETE 操作仅传业务主键
    

```sql
UPDATE t_event
SET is_deleted = 1
WHERE event_id = ?
```

## 10. 异常与补救机制

- 失败文件进入 `error` 目录
    
- 保留错误日志文件
    
- 支持人工修复后重新投递
    
- 重复投递依赖幂等机制保障安全
    

## 11. 安全与合规措施

- FTP 账号最小权限（只写）
    
- 文件内容白名单校验
    
- 字段长度、类型校验
    
- 全流程日志留痕
    
- 文件长期留存可审计
    

## 12. 项目部署建议

- 外网系统：独立项目部署
    
- 专网系统：独立项目部署
    
- 仅共享文件协议文档与 DTO 定义
    

---

**本方案适用于公安专网、政务内网等单向网络隔离场景，可直接用于立项、评审与实施。**